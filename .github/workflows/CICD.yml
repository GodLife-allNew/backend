name: CICD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    if: github.event.pull_request.merged == true || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Decode application-secret.properties
        run: |
          echo ${{ secrets.APPLICATION_SECRET }} | base64 --decode > ./src/main/resources/application-secret.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:${{ github.sha }} \
            .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/app
            
            # .env íŒŒì¼ ìƒì„±
            cat > .env << 'EOF'
            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            REDIS_HOST=redis
            REDIS_PORT=6379
            DOCKER_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            IMAGE_TAG=latest
            TZ=Asia/Seoul
            EOF
            
            chmod 600 .env
            echo "âœ“ Environment file updated"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "ðŸš€ Starting deployment..."
            ./scripts/deploy.sh
            
            DEPLOY_EXIT_CODE=$?
            if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Deployment failed! Starting rollback..."
              ./scripts/rollback.sh
              exit 1
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            
            echo "=== Current container status ==="
            docker ps --filter "name=blue" --filter "name=green" --format "table {{.Names}}\t{{.Status}}"
            
            echo ""
            echo "=== Current Nginx upstream ==="
            cat ./nginx/conf.d/service-env.inc
            
            echo ""
            echo "=== Health check ==="
            curl -s -k https://localhost/api/hc || echo "Health check failed"
            
            echo ""
            echo "=== Direct container health check ==="
            ACTIVE_CONTAINER=$(cat ./nginx/conf.d/service-env.inc | grep -oP '(?<=set \$service_url )\w+' | cut -d: -f1)
            echo "Active container: $ACTIVE_CONTAINER"
            docker exec $ACTIVE_CONTAINER wget -qO- http://localhost:9090/api/hc || echo "Direct check failed"

      - name: Cleanup old Docker images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

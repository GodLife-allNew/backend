name: CICD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    if: github.event.pull_request.merged == true || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Decode application-secret.properties
        run: |
          echo ${{ secrets.APPLICATION_SECRET }} | base64 --decode > ./src/main/resources/application-secret.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:${{ github.sha }} \
            .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/godlife_server:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2 using deploy script
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.GODLIFE_SERVER_IP }} << 'ENDSSH'
            set -e
            
            cd /home/ubuntu/app
            
            # .env ÌååÏùº ÏÉùÏÑ± (Îß§Î≤à ÏµúÏã† Ï†ïÎ≥¥Î°ú ÏóÖÎç∞Ïù¥Ìä∏)
            printf '%s\n' \
              "DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}" \
              "DB_NAME=${{ secrets.DB_NAME }}" \
              "DB_USER=${{ secrets.DB_USER }}" \
              "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              "REDIS_HOST=redis" \
              "REDIS_PORT=6379" \
              "DOCKER_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" \
              "IMAGE_TAG=latest" \
              "TZ=Asia/Seoul" \
              > .env
            
            chmod 600 .env
            echo "‚úì Environment file updated"
            
            # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
            echo "üöÄ Starting deployment..."
            ./scripts/deploy.sh
            
            DEPLOY_EXIT_CODE=$?
            if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Deployment successful!"
            else
              echo "‚ùå Deployment failed! Starting rollback..."
              ./scripts/rollback.sh
              exit 1
            fi
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.GODLIFE_SERVER_IP }} << 'ENDSSH'
            cd /home/ubuntu/app
            
            echo "=== Current container status ==="
            docker ps --filter "name=blue" --filter "name=green" --format "table {{.Names}}\t{{.Status}}"
            
            echo ""
            echo "=== Current Nginx upstream ==="
            cat ./nginx/conf.d/service-env.inc
            
            echo ""
            echo "=== Health check ==="
            curl -s -k https://localhost/api/hc || echo "Health check failed"
            
            echo ""
            echo "=== Direct container health check ==="
            ACTIVE_CONTAINER=$(cat ./nginx/conf.d/service-env.inc | grep -oP '(?<=set \$service_url )\w+' | cut -d: -f1)
            echo "Active container: $ACTIVE_CONTAINER"
            docker exec $ACTIVE_CONTAINER wget -qO- http://localhost:9090/api/hc || echo "Direct check failed"
          ENDSSH

      - name: Cleanup old Docker images
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.GODLIFE_SERVER_IP }} << 'ENDSSH'
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f
          ENDSSH
